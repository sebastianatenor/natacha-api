from fastapi import FastAPI, Request, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from routes import ctx_routes, ops_routes, tools_routes, tools_routes, tools_routes
import os

API_KEY = os.getenv("NATACHA_API_KEY", "dev-key")

app = FastAPI(title="natacha-api-a")

# ---- CORS ----
origins = ["*"]  # podés restringir luego
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ---- Auth básica (solo en métodos mutables) ----
@app.middleware("http")
async def check_auth(request: Request, call_next):
    if request.method in ("POST", "PATCH", "DELETE"):
        key = request.headers.get("x-api-key")
        if key != API_KEY:
            from starlette.responses import JSONResponse
            return JSONResponse({"ok": False, "error": "invalid API key"}, status_code=401)
    return await call_next(request)

# ---- Routers ----
app.include_router(ctx_routes.router)
app.include_router(ops_routes.router)
