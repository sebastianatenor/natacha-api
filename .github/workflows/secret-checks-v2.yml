name: Secret Checks (v2)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * 1'  # lunes 09:00 UTC

permissions:
  contents: read

jobs:
  check:
    name: Validate GCP service-account secret
    runs-on: ubuntu-24.04
    env:
      GCP_SA_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    steps:
      - name: Sanity
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${GCP_SA_KEY:-}" ]]; then
            echo "::error title=Secret missing::GCP_SERVICE_ACCOUNT_KEY is not set"
            exit 1
          fi
          echo "Secret is set ✅ (value is masked)"

      - name: Write to file (masked) & validate JSON
        shell: bash
        run: |
          set -euo pipefail
          umask 077
          printf '%s' "$GCP_SA_KEY" > key.json
          python3 -c "import json,sys; json.load(open('key.json','r',encoding='utf-8')); print('Valid JSON ✅')"

      - name: Cleanup
        if: always()
        run: rm -f key.json
