name: 🚀 Natacha CI/CD

on:
  push:
    branches:
      - main
    paths:
      - "memory_console/**"
      - "natacha_core/**"
      - "app.py"
      - "Dockerfile"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: asistente-sebastian
      REGION: us-central1
      AR_REPO: natacha-repo
      MEMORY_SERVICE: memory_console
      CORE_SERVICE: natacha_core
      API_SERVICE: natacha-api

    steps:
      - name: 🧩 Checkout repo
        uses: actions/checkout@v4

      - name: 🔐 Auth with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          create_credentials_file: true
          export_environment_variables: true

      - name: 🐳 Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: 🧪 Test GCP secret (debug)
        run: |
          echo "🔍 Probando secret..."
          if [ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "❌ Secret vacío"
            exit 1
          else
            echo "✅ Secret presente"
          fi

      # 1) memory_console
      - name: 🏗️ Build & Push memory_console
        run: |
          docker build -t us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/memory_console:latest \
            -f memory_console/Dockerfile \
            memory_console
          docker push us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/memory_console:latest

      # 2) core
      - name: 🏗️ Build & Push natacha_core
        run: |
          docker build -t us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/natacha_core:latest \
            -f natacha_core/Dockerfile \
            natacha_core
          docker push us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/natacha_core:latest

      # 3) api (Dockerfile raíz)
      - name: 🏗️ Build & Push API (root Dockerfile)
        run: |
          docker build -t us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/natacha-api:latest \
            -f Dockerfile \
            .
          docker push us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/natacha-api:latest

      - name: 🚀 Deploy to Cloud Run
        run: |
          gcloud run deploy natacha-memory-console \
            --image us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/memory_console:latest \
            --region ${REGION} --platform managed --allow-unauthenticated

          gcloud run deploy natacha-core \
            --image us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/natacha_core:latest \
            --region ${REGION} --platform managed --allow-unauthenticated

          gcloud run deploy natacha-api \
            --image us-central1-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/natacha-api:latest \
            --region ${REGION} --platform managed --allow-unauthenticated

      - name: ✅ Health Check
        run: |
          curl -f https://natacha-api-${REGION}.a.run.app/health
