name: "üöÄ Natacha CI/CD"

on:
  push:
    branches:
      - main
    paths:
      - "memory_console/**"
      - "natacha_core/**"
      - "app/**"
      - "app.py"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: asistente-sebastian
      REGION: us-central1
      # nombres reales seg√∫n tu repo actual
      MEMORY_SERVICE: natacha-memory-console
      CORE_SERVICE: natacha-core
      API_SERVICE: natacha-api

    steps:
      - name: "üß© Checkout repo"
        uses: actions/checkout@v4

      - name: "üîê Auth with Google Cloud"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          token_format: "access_token"

      - name: "üê≥ Setup Docker"
        uses: docker/setup-buildx-action@v3

      - name: "üß™ Test GCP secret (debug)"
        run: |
          echo "üîç Probando si el secret GCP_SERVICE_ACCOUNT_KEY llega desde GitHub..."
          if [ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "‚ùå El secret GCP_SERVICE_ACCOUNT_KEY est√° VAC√çO o no est√° definido."
            exit 1
          else
            echo "‚úÖ El secret GCP_SERVICE_ACCOUNT_KEY est√° presente."
          fi

      # -----------------------------
      # 1) memory_console (tu carpeta S√ç existe)
      # -----------------------------
      - name: "üèóÔ∏è Build & Push memory_console"
        run: |
          if [ -d "memory_console" ] && [ -f "memory_console/Dockerfile" ]; then
            echo "üì¶ Build de memory_console ..."
            docker build \
              -t gcr.io/${PROJECT_ID}/memory_console:latest \
              -f memory_console/Dockerfile \
              memory_console
            docker push gcr.io/${PROJECT_ID}/memory_console:latest
          else
            echo "‚ö†Ô∏è No existe memory_console/ o no tiene Dockerfile. Lo salto."
          fi

      # -----------------------------
      # 2) natacha_core (en tu repo existe la carpeta natacha_core/)
      # -----------------------------
      - name: "üèóÔ∏è Build & Push natacha_core"
        run: |
          if [ -d "natacha_core" ] && [ -f "natacha_core/Dockerfile" ]; then
            echo "üì¶ Build de natacha_core ..."
            docker build \
              -t gcr.io/${PROJECT_ID}/natacha_core:latest \
              -f natacha_core/Dockerfile \
              natacha_core
            docker push gcr.io/${PROJECT_ID}/natacha_core:latest
          else
            echo "‚ö†Ô∏è No existe natacha_core/ o no tiene Dockerfile. Lo salto."
          fi

      # -----------------------------
      # 3) API principal (tu Dockerfile ra√≠z)
      # -----------------------------
      - name: "üèóÔ∏è Build & Push API (Dockerfile ra√≠z)"
        run: |
          if [ -f "Dockerfile" ]; then
            echo "üì¶ Build de API ra√≠z ..."
            docker build \
              -t gcr.io/${PROJECT_ID}/natacha-api:latest \
              -f Dockerfile \
              .
            docker push gcr.io/${PROJECT_ID}/natacha-api:latest
          else
            echo "‚ö†Ô∏è No hay Dockerfile ra√≠z. Lo salto."
          fi

      # -----------------------------
      # 4) Deploy a Cloud Run (solo lo que haya logrado build)
      # -----------------------------
      - name: "üöÄ Deploy to Cloud Run"
        run: |
          echo "üöÄ Deploy servicios disponibles..."

          # memory_console
          if docker image inspect gcr.io/${PROJECT_ID}/memory_console:latest > /dev/null 2>&1; then
            gcloud run deploy natacha-memory-console \
              --image gcr.io/${PROJECT_ID}/memory_console:latest \
              --region ${REGION} \
              --platform managed \
              --allow-unauthenticated
          else
            echo "‚ö†Ô∏è No hay imagen de memory_console para desplegar."
          fi

          # core
          if docker image inspect gcr.io/${PROJECT_ID}/natacha_core:latest > /dev/null 2>&1; then
            gcloud run deploy natacha-core \
              --image gcr.io/${PROJECT_ID}/natacha_core:latest \
              --region ${REGION} \
              --platform managed \
              --allow-unauthenticated
          else
            echo "‚ö†Ô∏è No hay imagen de natacha_core para desplegar."
          fi

          # api
          if docker image inspect gcr.io/${PROJECT_ID}/natacha-api:latest > /dev/null 2>&1; then
            gcloud run deploy natacha-api \
              --image gcr.io/${PROJECT_ID}/natacha-api:latest \
              --region ${REGION} \
              --platform managed \
              --allow-unauthenticated
          else
            echo "‚ö†Ô∏è No hay imagen de natacha-api para desplegar."
          fi

      - name: "‚úÖ Health Check"
        run: |
          echo "‚åõ Health de la API..."
          curl -f https://natacha-api-${{ env.REGION }}.a.run.app/health || true
